# mwARK
Скрипты для работы с ARKwiki

## 1. Установка
### 1.1. Предустановка нужных программ
Для установки вам потребуется __NodeJS__ и установщик пакетов, я предпочитаю __Yarn__. Так же вам понадобится установленный __Git__, для копирования этого репозитория. Для всех трех программ достаточно будет стандартной установки _(Далее → Далее → ... → Финиш)_.

### 1.2. Установка mwARK
Когда нужные программы уже установлены, запускаем командную строку _(Win + R и пишем cmd, нажимаем Enter для Windows)_ или консоль _(Ctrl  + Alt + T для Linux)_. В консоли с помощью команды ``cd`` переходим в нужную директорию (туда, куда мы поставим всё для работы с _MediaWiki_).

Пишем команду для инициализации нашего проекта
```
yarn init -y
```

И теперь устанавливаем пакет ``mwARK``:
```
yarn add  https://github.com/TigerMehMat/mwARK.git
```

Отлично, теперь всё нужное установлено! Осталось только получить логин и пароль для нашего бота.

## 1.3. Получение Логина и Пароля для Бота на MediaWiki
На любой вики (EN или RU) переходим на страницу ``Special:BotPasswords`` (под своим логином и паролем) и создаем  там своего бота. Итоговый Логин и Пароль запомните, они вам пригодятся.

## 1.4. Обновление пакета
Для обновления пакета откройте консоль, перейдите в папку с приложением и выполните команду консоли
```
yarn upgrade
```

## 2. Первый запуск
``mwARK`` - консольное приложение. Запускать его можно только через консоль.

Теперь создаем в папке, куда мы всё устанавливали, файл __index.js__ и открываем его с помощью блокнота или другой программы для редактирования кода. Копируем туда следующий код:
```javascript
var startBot = require('mwARK');
const fs = require("fs");
var options = {
  "config-ru": {
    "username": "<Логин Бота>",
    "password": "<Пароль Бота>",
    "server": "ark-ru.gamepedia.com",
  },
  "config-en": {
    "username": "<Логин Бота>",
    "password": "<Пароль Бота>",
    "server": "ark.gamepedia.com",
  },
  "functions": {
    "imageredirect": fs.readFileSync('./redirects.txt', 'utf8'),
  }
};

startBot(options);
```
Заменяем части ``<Логин  Бота>`` и ``<Пароль Бота>`` на логин и пароль бота _(полученные в п.1.3.)_ соответственно.

### 2.1. Разберем по частям

Подключаем модуль ``mwARK``:
```javascript
var startBot = require('mwARK');
```
Подключаем модуль ``fs``, он нужен для чтения файлов. Отдельной установки  он не требует и входит в пакет __NodeJS__:
```javascript
const fs = require("fs");
```

Теперь добавим настройки для бота:
```javascript
var options = {
  "config-ru": {
    "username": "<Логин Бота>",
    "password": "<Пароль Бота>",
    "server": "ark-ru.gamepedia.com",
  },
  "config-en": {
    "username": "<Логин Бота>",
    "password": "<Пароль Бота>",
    "server": "ark.gamepedia.com",
  },
  "functions": {
    "imageredirect": fs.readFileSync('./redirects.txt', 'utf8'),
  }
};
```
``config-ru`` и ``config-en`` мы настроим один раз и более к ним возвращаться не будем, а вот ``functions`` требует более глубокого рассмотрения и, собственно, будет рассмотрено в отдельное главе.

И последнее - запуск бота с настройками:
```javascript
startBot(options);
```

## 3. Функции

В скопированном коде мы видим следующий блок кода:
```javascript
"functions": {
    "imageredirect": fs.readFileSync('./redirects.txt', 'utf8'),
  }
```
Он отвечает за запуск функций бота для обработки. Если его оставить пустым
```javascript
"functions": {
  }
```
То бот подключится к вики, но ничего не сделает.

В базовом примере всего одна функция - ``imageredirect``, она принимает всего один параметр - список файловых перенаправлений. Чтобы каждый раз на писать этот список из кода, он берется из файла _redirects.js_ с помощью чтения через ``fs.readFileSync``. Не забывайте указывать кодировку файла. Подробнее о разных функциях читайте ниже.

### 3.1. ImageRedirect - добавление файловых перенаправлений

Довольно обширная функция и самая первая на этом проекте. В качестве параметра принимает строку в определенном виде, содержащую список файловых перенаправлений. Обычно в качестве строки передают результат файла _redirects.txt_:
```javascript
"imageredirect": fs.readFileSync('./redirects.txt', 'utf8'),
```
А вот вся магия делается в файле _redirects.txt_, далее речь пойдет о его содержимом.

#### 3.1.1. redirects.txt

В этом файле хранятся перенаправления в следующем виде:
```
Русское Название Файла.png | English Filename.png
Русское Название Второго Файла.svg | English Filename2.svg
```
Разделителем английского и русского варианта является | (вертикальная черта), разделителем разных перенаправлений - перенос строки. Пробелы около вертикальной черты, в начале и конце названия файла не учитываются, но пробелы в середине слова важны.

#### 3.1.2. Сокращения

##### 3.1.2.1. Не обязательно писать .png
Если у файла отсутствует разрешение, то автоматически подставляется _.png_. То есть код
```
Безымянный | Nameless
Безымянный - Арена Роквелла | Nameless - Rockwell Arena
Безымянный - Поверхность | Nameless - The Surface
```
равносилен
```
Безымянный.png | Nameless.png
Безымянный - Арена Роквелла.png | Nameless - Rockwell Arena.png
Безымянный - Поверхность.png | Nameless - The Surface.png
```

##### 3.1.2.2. Множественные перенаправления на одну страницу

В одной строке через | (вертикальную черту) можно указать несколько перенаправлений на одну и ту же страницу, которая должна быть последней в списке. Например код
```
Корм (Яйцо Аллозавра) | Корм (Яйцо Бронтозавра) | Корм (Яйцо Карбонемиса) | Kibble
```
равносилен
```
Корм (Яйцо Аллозавра) | Kibble
Корм (Яйцо Бронтозавра) | Kibble
Корм (Яйцо Карбонемиса) | Kibble
```

#### 3.1.3. Шаблоны

Шаблоны - более сложная структура чем сокращения. Шаблоны могут строить собственные списки на основании введенных данных. Для использования шаблона достаточно указать его название перед перенаправлением через двоетоие ``шаблон: перенаправление | redirect``. На данный момент существует только один шаблон - для карт.

##### 3.1.3.1. Карта
Этот шаблон генерирует перенаправления всех известных карт для указанного существа, пропуская несуществующие карты. Например, код
```
карта: Тираннозавр | Rex
карта: Додо | Dodo
```
равносильно
```
Spawning_Тираннозавр_The_Island.svg | Spawning_Rex_The_Island.svg
Spawning_Тираннозавр_Extinction.svg | Spawning_Rex_Extinction.svg
Spawning_Тираннозавр_Scorched_Earth.svg | Spawning_Rex_Scorched_Earth.svg
Spawning_Тираннозавр_The_Center.svg | Spawning_Rex_The_Center.svg
Spawning_Тираннозавр_Ragnarok.svg | Spawning_Rex_Ragnarok.svg
Spawning_Додо_The_Island.svg | Spawning_Dodo_The_Island.svg
Spawning_Додо_Aberration.svg | Spawning_Dodo_Aberration.svg
Spawning_Додо_Extinction.svg | Spawning_Dodo_Extinction.svg
Spawning_Додо_The_Center.svg | Spawning_Dodo_The_Center.svg
Spawning_Додо_Ragnarok.svg | Spawning_Dodo_Ragnarok.svg
```
Обратите внимание, что у Тираннозавра отсутствует карта Aberration, а у Додо нет карты Scorched_Earth. Это связано с тем, что данные существа не имеют респов на этих картах.


### 3.2. Copy

Эта функция предназначена для копирования страниц с EN-wiki на RU-wiki, с возможностью поменять данные во время копирования. Принимает в качестве параметра объект, состоящий из следующих параметров: ``in`` - английская статья (откуда копировать), ``out`` - статья на RU-wiki (куда копировать) и необязательный параметр ``func`` - название стандартной функции обработки или сама функция.
```javascript
"copy": {
  "in": "Template:Do for every creature",
  "out": "Шаблон:Делать_для_каждого_существа",
  "func": "translateCreaturesIcons",
}
```
На коде выше представлен пример для копирования шаблона с иконками с англ вики и переводом всех существ на русский язык.

Для простого копирования нужно оставить поле пустым или вовсе убрать строку ``func``.

Обратите внимание, что если у копируемой статьи встретится запись ``[[ru:Название статьи куда копирует скрипт]]``, то она будет заменена на ``[[en:Название статьи откуда копировали]]``

Если же такой строчки не встретится, скрипт добавит её на англ вики перед ``{{MissingTranslates}}`` или в конце статьи. Чтобы отключить эту функцию, добавьте параметр ``"translate": false``
```javascript
"copy": {
  "in": "Template:Do for every creature",
  "out": "Шаблон:Делать_для_каждого_существа",
  "func": "translateCreaturesIcons",
  "translate": false,
}
```

Пример использования с собственной функцией (добавить категорию "скопировано" в конец):
```javascript
"copy": {
  "in": "Template:Do for every creature",
  "out": "Шаблон:Делать_для_каждого_существа",
  "func": function(text){
    return text + '\n[[Категория:Скопировано]]';
  },
  "translate": false,
}
```

На данный момент существует только две стандартные функции для обработки текста. ``translateCreaturesText`` и ``translateCreaturesIcons``, они предназначены только для определенных страниц:
``translateCreaturesText`` для текстовых алиасов следующего копирования:

```javascript
"copy": {
  "in": "Template:Nav creatures/Text",
  "out": "Шаблон:Нав Существа/Текст‎‎",
  "func": "translateCreaturesText",
}
```

И ``translateCreaturesIcons`` для

```javascript
"copy": {
  "in": "Template:Do for every creature",
  "out": "Шаблон:Делать_для_каждого_существа",
  "func": "translateCreaturesIcons",
}
```

На этом всё, удачи в переводах ;)
